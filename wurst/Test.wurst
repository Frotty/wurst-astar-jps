package Test
import Assets
import ClosureEvents
import AstarJPS
import TerrainUtils
import ClosureTimers

var first = ZERO2


function onMouse()
    let mx = BlzGetTriggerPlayerMouseX()
    let my = BlzGetTriggerPlayerMouseY()
    let mpos = vec2(mx, my)
    let eff = addEffect(Abilities.vengeanceMissile, mpos)
    doAfter(5.) () ->
        eff.destr()

    if first == ZERO2
        first = mpos
    else
        let finder = new Pathfinder(first, mpos)
        finder.stepDelay = 0.05
        finder.debug = true
        finder.outputPath = true
        finder.setCond() (test) ->
            return test.isTerrainWalkable()

        finder.search() (res) ->
            if res.success
                Log.info("Path found. Nodes = " + res.nodes.size().toString())
                for i = 0 to res.nodes.size() - 2
                    addLightning(LIGHTNING_CHAIN_LIGHTNING_PRIMARY, false, res.nodes.get(i).t, res.nodes.get(i + 1).t)
                    res.nodes.get(i)

        first = ZERO2

init
    EventListener.add(EVENT_PLAYER_MOUSE_DOWN, () -> onMouse())
    FogEnable(false)
    FogMaskEnable(false)
    doAfter(1.) ->
        let des = createDestructable('KTtw', ZERO2.add(111, 222), 0 .fromDeg(), 1, 1)
        CreateTrigger()..registerDeathEvent(des)
        ..addAction() ->
            print("widget: " + GetTriggerWidget().getPos().toString())

        doAfter(1.) ->
            des.kill()
